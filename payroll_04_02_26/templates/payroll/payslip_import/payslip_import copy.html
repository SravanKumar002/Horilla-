
% extends 'index.html' %} {% load static i18n %} {% block content %}
<style>
  .payslip-import-modal {
    font-family: "Inter", sans-serif;
  }

  .note {
    font-size: 14px;
    color: #c45b00;
    margin-bottom: 10px;
    padding: 10px 15px;
    background-color: #fff3e0;
    border-left: 4px solid #ff9800;
    border-radius: 6px;
  }

  /* Section Container */
  .payroll-section {
    background: white;
    border-radius: 16px;
    padding: 30px;
    box-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
    margin-bottom: 30px;
  }

  /* Section Header */
  .section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
  }

  .section-title-wrapper {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .section-icon {
    font-size: 24px;
  }

  .section-title {
    font-size: 22px;
    font-weight: 700;
    color: #333;
    margin: 0;
  }

  .section-subtitle {
    font-size: 14px;
    color: #666;
    margin: 5px 0 0 36px;
  }

  /* Payroll Period Section */
  .period-selection-display {
    background: #f8f9fa;
    border: 2px solid #e0e0e0;
    border-radius: 8px;
    padding: 15px 20px;
    margin-bottom: 25px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    cursor: pointer;
    transition: all 0.3s;
  }

  .period-selection-display:hover {
    border-color: #7A34AB;
    background: #f5f5f5;
  }

  .period-display-content {
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 18px;
    font-weight: 600;
    color: #333;
  }

  .period-caret {
    font-size: 18px;
    color: #666;
  }

  .fiscal-year-toggle {
    background: #fff;
    border: 1px solid #e0e0e0;
    border-radius: 6px;
    padding: 8px 14px;
    font-size: 14px;
    font-weight: 500;
    color: #333;
    cursor: pointer;
    display: flex;
    align-items: center;
    gap: 6px;
    transition: all 0.3s;
  }

  .fiscal-year-toggle:hover {
    background: #f5f5f5;
    border-color: #7A34AB;
  }

  /* Month Grid */
  .month-grid-container {
    margin-top: 20px;
  }

  .year-navigation {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
  }

  .year-nav-arrow {
    background: none;
    border: none;
    font-size: 20px;
    cursor: pointer;
    color: #666;
    padding: 5px 10px;
    transition: all 0.3s;
  }

  .year-nav-arrow:hover {
    color: #7A34AB;
  }

  .year-display {
    font-size: 20px;
    font-weight: 600;
    color: #333;
    min-width: 80px;
    text-align: center;
  }

  .month-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 15px;
  }

  .month-card {
    background: #f8f9fa;
    border: 2px solid #e8e8e8;
    border-radius: 8px;
    padding: 15px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s;
    font-size: 15px;
    font-weight: 600;
    color: #333;
  }

  .month-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #7A34AB;
  }

  .month-card.active {
    background: #2d8659;
    color: #fff;
    border-color: #2d8659;
    box-shadow: 0 4px 12px rgba(45, 134, 89, 0.3);
  }

  .month-card h4 {
    margin: 0 0 10px 0;
    font-size: 17px;
    font-weight: 700;
  }

  .month-card p {
    margin: 6px 0;
    font-size: 13px;
    opacity: 0.85;
  }

  .month-status {
    display: inline-block;
    padding: 5px 14px;
    border-radius: 20px;
    font-size: 12px;
    background-color: #e0e0e0;
    color: #555;
    margin-top: 10px;
    font-weight: 600;
    text-transform: capitalize;
  }

  .month-card.active .month-status {
    background-color: rgba(255, 255, 255, 0.3);
    color: #fff;
  }

  .status-indicators {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 20px;
    padding-top: 15px;
    border-top: 1px solid #e0e0e0;
  }

  .status-indicator {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
  }

  .status-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: #4caf50;
  }

  .status-locked {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
  }

  /* Hidden year select for functionality */
  .hidden-year-select {
    display: none;
  }

  /* Download Template Section */
  .template-section-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 20px;
    padding-bottom: 15px;
    border-bottom: 2px solid #f0f0f0;
  }

  .employee-count {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 14px;
    color: #666;
    font-weight: 500;
  }

  .template-cards {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 20px;
    margin-bottom: 30px;
  }

  .template-card {
    background: #f8f9fa;
    border: 2px solid #e8e8e8;
    border-radius: 12px;
    padding: 20px;
    transition: all 0.3s;
  }

  .template-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    border-color: #7A34AB;
  }

  .template-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: 12px;
  }

  .template-card-title {
    font-size: 18px;
    font-weight: 700;
    color: #333;
    margin: 0;
  }

  .recommended-badge {
    background: #4caf50;
    color: white;
    font-size: 11px;
    font-weight: 600;
    padding: 4px 10px;
    border-radius: 12px;
    text-transform: uppercase;
  }

  .template-card-description {
    font-size: 14px;
    color: #666;
    margin-bottom: 15px;
    line-height: 1.5;
  }

  .template-card-meta {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #666;
    margin-bottom: 12px;
  }

  .template-card-fields {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 13px;
    color: #666;
    margin-bottom: 20px;
  }

  .template-download-btn {
    width: 100%;
    padding: 12px;
    border: none;
    border-radius: 8px;
    font-size: 15px;
    font-weight: 600;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    transition: all 0.3s;
  }

  .template-download-btn.primary {
    background: #2d8659;
    color: white;
  }

  .template-download-btn.primary:hover {
    background: #256b47;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(45, 134, 89, 0.3);
  }

  .template-download-btn.secondary {
    background: #e8e8e8;
    color: #333;
  }

  .template-download-btn.secondary:hover {
    background: #d0d0d0;
  }

  /* Template Features */
  .template-features {
    margin-top: 30px;
    padding-top: 20px;
    border-top: 2px solid #f0f0f0;
  }

  .template-features-title {
    display: flex;
    align-items: center;
    gap: 8px;
    font-size: 16px;
    font-weight: 600;
    color: #333;
    margin-bottom: 15px;
  }

  .template-features-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .template-features-list li {
    padding: 8px 0;
    padding-left: 25px;
    position: relative;
    font-size: 14px;
    color: #666;
    line-height: 1.6;
  }

  .template-features-list li:before {
    content: "‚Ä¢";
    position: absolute;
    left: 10px;
    color: #7A34AB;
    font-weight: bold;
    font-size: 18px;
  }

  /* Upload section */
  .upload-section {
    margin-top: 30px;
    padding-top: 30px;
    border-top: 2px solid #f0f0f0;
  }

  .upload-controls {
    display: flex;
    align-items: center;
    gap: 20px;
    flex-wrap: wrap;
  }

  .upload-link {
    color: #007bff;
    text-decoration: none;
    font-weight: 600;
    display: flex;
    align-items: center;
    gap: 8px;
    cursor: pointer;
    padding: 10px 16px;
    border-radius: 6px;
    transition: all 0.3s;
    border: 2px solid #007bff;
  }

  .upload-link:hover {
    background-color: #007bff;
    color: white;
    text-decoration: none;
  }

  .upload-wrapper p {
    font-size: 12px;
    color: #666;
    margin: 5px 0 0 0;
  }

  .submit-btn {
    padding: 10px 24px;
    background-color: #7A34AB;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    opacity: 0.6;
    font-weight: 600;
    font-size: 15px;
    transition: all 0.3s;
  }

  .submit-btn.enabled {
    opacity: 1;
    box-shadow: 0 4px 12px rgba(122, 52, 171, 0.3);
  }

  .submit-btn.enabled:hover {
    background-color: #6a2d99;
    transform: translateY(-2px);
    box-shadow: 0 6px 16px rgba(122, 52, 171, 0.4);
  }

  .submit-btn:disabled {
    cursor: not-allowed;
  }

  .alert {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
  }

  .alert-success {
    background-color: #d4edda;
    border-color: #c3e6cb;
    color: #155724;
  }

  .alert-error {
    background-color: #f8d7da;
    border-color: #f5c6cb;
    color: #721c24;
  }

  /* Responsive */
  @media (max-width: 1200px) {
    .template-cards {
      grid-template-columns: repeat(2, 1fr);
    }
    .month-grid {
      grid-template-columns: repeat(3, 1fr);
    }
  }

  @media (max-width: 768px) {
    .template-cards {
      grid-template-columns: 1fr;
    }
    .month-grid {
      grid-template-columns: repeat(2, 1fr);
    }
    .section-header,
    .template-section-header {
      flex-direction: column;
      align-items: flex-start;
      gap: 15px;
    }
  }

  @media (max-width: 480px) {
    .month-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<div class="oh-modal__dialog-header">
  <h2 class="oh-modal__dialog-title" id="objectDetailsModalLabel">
    {% trans "Import Payslips" %}
  </h2>
  <button class="oh-modal__close" aria-label="Close">
    <ion-icon name="close-outline" role="img" class="md hydrated" aria-label="close outline"></ion-icon>
  </button>
</div>

<div class="oh-modal__dialog-body oh-modal__dialog-relative payslip-import-modal">
  <!-- Notes -->
  <p class="note">
    üìå Please upload an Excel file with employee_id and wage/basic_pay columns. Payslips will be automatically
    calculated based on attendance and leave records.
  </p>
  <p class="note">
    ‚ö†Ô∏è On upload, salary will be regenerated if already generated and not paid. Excel should contain: employee_id, wage
    (or basic_pay), housing_allowance (optional), transport_allowance (optional), other_allowance (optional).
  </p>

  <!-- Alert Messages -->
  <div id="alertContainer"></div>

  <!-- Payroll Period Section -->
  <div class="payroll-section">
    <div class="section-header">
      <div>
        <div class="section-title-wrapper">
          <span class="section-icon">üìÖ</span>
          <h2 class="section-title">Payroll Period</h2>
        </div>
        <p class="section-subtitle">Select month for processing</p>
      </div>
      <button class="fiscal-year-toggle" onclick="toggleFiscalYear()">
        <span>‚ÑπÔ∏è</span>
        Fiscal Year
      </button>
    </div>

    <div class="period-selection-display" onclick="toggleMonthSelector()">
      <div class="period-display-content">
        <span>üìÖ</span>
        <span id="selectedPeriodDisplay">{{ months_data.0.month_name|default:"December" }} {{ current_year|default:"2026" }}</span>
      </div>
      <span class="period-caret">‚ñ≤</span>
    </div>

    <!-- Hidden year select for functionality -->
    <input type="number" id="yearSelect" class="hidden-year-select" placeholder="Select Year" min="2000" max="2100"
      value="{{ current_year }}" oninput="debounceUpdateYear(this)" />

    <div class="month-grid-container" id="monthSelectorContainer">
      <div class="year-navigation">
        <button class="year-nav-arrow" onclick="changeYear(-1)">‚Äπ</button>
        <span class="year-display" id="yearDisplay">{{ current_year|default:"2026" }}</span>
        <button class="year-nav-arrow" onclick="changeYear(1)">‚Ä∫</button>
      </div>

      <!-- Month Grid (4x3) -->
      <div class="month-grid" id="monthGrid">
        {% for month_data in months_data %}
        <div class="month-card {% if month_data.month_num == current_month %}active{% endif %}"
          data-month="{{ month_data.month_num }}" onclick="selectMonth(this)">
          <h4>{{ month_data.month_name }} {{ month_data.year }}</h4>
          <p>{{ month_data.date_range }}</p>
          <span class="month-status">{{ month_data.status }}</span>
        </div>
        {% endfor %}
      </div>

      <div class="status-indicators">
        <div class="status-indicator">
          <span class="status-dot"></span>
          <span>Selected</span>
        </div>
        <div class="status-locked">
          <span>üîí</span>
          <span>Locked Period</span>
        </div>
      </div>
    </div>
  </div>

  <!-- Download Template Section -->
  <div class="payroll-section">
    <div class="template-section-header">
      <div>
        <div class="section-title-wrapper">
          <span class="section-icon">üì•</span>
          <h2 class="section-title">Download Template</h2>
        </div>
        <p class="section-subtitle">Excel templates with auto-populated data</p>
      </div>
      <div class="employee-count">
        <span>üë•</span>
        <span>1247 Employees</span>
      </div>
    </div>

    <div class="template-cards">
      <!-- Standard Payroll Template -->
      <div class="template-card">
        <div class="template-card-header">
          <h3 class="template-card-title">Standard Payroll Template</h3>
          <span class="recommended-badge">Recommended</span>
        </div>
        <p class="template-card-description">Pre-populated with employee data from contracts</p>
        <div class="template-card-meta">
          <span>üìÑ</span>
          <span>2.4 MB</span>
        </div>
        <div class="template-card-fields">
          <span>üìã</span>
          <span>Employee ID, Name, Pay Type, Base Rate, Bank Info</span>
        </div>
        <button class="template-download-btn primary" onclick="downloadTemplate(event)">
          <span>üì•</span>
          Download
        </button>
      </div>

      <!-- Detailed Payroll Template -->
      <div class="template-card">
        <div class="template-card-header">
          <h3 class="template-card-title">Detailed Payroll Template</h3>
        </div>
        <p class="template-card-description">Includes allowances, deductions, and bonus columns</p>
        <div class="template-card-meta">
          <span>üìÑ</span>
          <span>3.1 MB</span>
        </div>
        <div class="template-card-fields">
          <span>üìã</span>
          <span>All standard fields + Allowances, Deductions, Bonuses</span>
        </div>
        <button class="template-download-btn secondary" onclick="downloadPayslips(event)">
          <span>üì•</span>
          Download
        </button>
      </div>

      <!-- Custom Template -->
      <div class="template-card">
        <div class="template-card-header">
          <h3 class="template-card-title">Custom Template</h3>
        </div>
        <p class="template-card-description">Blank template for manual data entry</p>
        <div class="template-card-meta">
          <span>üìÑ</span>
          <span>1.8 MB</span>
        </div>
        <div class="template-card-fields">
          <span>üìã</span>
          <span>Customizable columns</span>
        </div>
        <button class="template-download-btn secondary" onclick="downloadPayslips(event)">
          <span>üì•</span>
          Download
        </button>
      </div>
    </div>

    <div class="template-features">
      <div class="template-features-title">
        <span>‚ÑπÔ∏è</span>
        <span>Template Features</span>
      </div>
      <ul class="template-features-list">
        <li>Auto-populated employee data from active contracts</li>
        <li>Pre-configured formulas for calculations</li>
        <li>Data validation to prevent errors</li>
        <li>Compatible with Excel 2016 and later versions</li>
      </ul>
    </div>

    <!-- Upload Section -->
    <div class="upload-section">
      <div class="upload-controls">
        <label class="upload-link">
          <span>üìé</span>
          Attach Payslip Excel File
          <input type="file" style="display: none" id="fileInput" accept=".xlsx,.xls,.csv"
            onchange="enableSubmit(this)" />
        </label>
        <div class="upload-wrapper">
          <p>Max file size: 10MB | Format: .xlsx, .xls, .csv</p>
        </div>
        <button class="submit-btn" id="submitBtn" disabled onclick="submitImport()">Submit</button>
      </div>
    </div>
  </div>
</div>

<script>
  // Adjust modal width for import interface
  $(document).ready(function () {
    var modalDialog = $('#objectDetailsModal .oh-modal__dialog');
    if (modalDialog.length) {
      modalDialog.css('max-width', '90%');
      modalDialog.css('width', '1200px');
    }
  });

  let selectedMonth = parseInt("{{ current_month|default:0 }}") || 0;
  let selectedYear = parseInt("{{ current_year|default:0 }}") || 0;
  let selectedFile = null;

  // Month names for display
  const monthNames = [
    'January', 'February', 'March', 'April', 'May', 'June',
    'July', 'August', 'September', 'October', 'November', 'December'
  ];

  // Update selected period display
  function updateSelectedPeriodDisplay() {
    const display = document.getElementById('selectedPeriodDisplay');
    if (display && selectedMonth >= 0 && selectedMonth < 12) {
      display.textContent = `${monthNames[selectedMonth]} ${selectedYear}`;
    }
  }

  // Initialize display
  updateSelectedPeriodDisplay();

  // Function to change year with navigation arrows
  function changeYear(delta) {
    const yearInput = document.getElementById('yearSelect');
    const yearDisplay = document.getElementById('yearDisplay');
    selectedYear = parseInt(yearInput.value) + delta;
    yearInput.value = selectedYear;
    yearDisplay.textContent = selectedYear;
    updateSelectedPeriodDisplay();
    // Trigger year update
    debounceUpdateYear(yearInput);
  }

  // Debounce function for year input
  let timeout = null;
  function debounceUpdateYear(input) {
    const year = input.value;
    selectedYear = parseInt(year) || selectedYear;
    updateSelectedPeriodDisplay();
    // Only reload if it looks like a valid year (4 digits)
    if (year.length === 4 && year >= 2000 && year <= 2100) {
      clearTimeout(timeout);
      timeout = setTimeout(function () {
        window.location.href = `{% url 'payslip-info-import' %}?year=${year}`;
      }, 800); // 800ms delay to let user finish typing
    }
  }

  // Active month selection
  function selectMonth(card) {
    document.querySelectorAll(".month-card").forEach((c) => c.classList.remove("active"));
    card.classList.add("active");
    selectedMonth = parseInt(card.dataset.month);
    updateSelectedPeriodDisplay();
    console.log("Selected Month:", selectedMonth);
  }

  // Toggle month selector (for future dropdown functionality)
  function toggleMonthSelector() {
    console.log("Toggle month selector");
    // Could add show/hide functionality here if needed
  }

  // Toggle fiscal year
  function toggleFiscalYear() {
    console.log("Toggle fiscal year");
    // Add fiscal year logic here if needed
  }

  // Enable submit when file chosen
  function enableSubmit(input) {
    const btn = document.getElementById("submitBtn");
    if (input.files.length > 0) {
      selectedFile = input.files[0];
      btn.disabled = false;
      btn.classList.add("enabled");
    } else {
      selectedFile = null;
      btn.disabled = true;
      btn.classList.remove("enabled");
    }
  }

  // Download template (company-wise, server-generated)
  function downloadTemplate(event) {
    event.preventDefault();
    // Uses the selected company from navbar (stored in session)
    // and returns a CSV template prefilled with Employee Id & Name.
    const url = '{% url "payslip-import-template" %}';
    window.location.href = url;
  }

  // Download generated payslips
  function downloadPayslips(event) {
    event.preventDefault();
    if (!selectedMonth || !selectedYear) {
      showAlert('Please select a month and year first.', 'error');
      return;
    }

    const url = '{% url "payslip-import-download" %}?month=' + selectedMonth + '&year=' + selectedYear;
    window.location.href = url;
  }

  // Submit import
  function submitImport() {
    if (!selectedFile || !selectedMonth || !selectedYear) {
      showAlert('Please select a file, month, and year.', 'error');
      return;
    }

    const formData = new FormData();
    formData.append('file', selectedFile);
    formData.append('month', selectedMonth);
    formData.append('year', selectedYear);
    formData.append('csrfmiddlewaretoken', '{{ csrf_token }}');

    const submitBtn = document.getElementById('submitBtn');
    submitBtn.disabled = true;
    submitBtn.textContent = 'Processing...';

    fetch('{% url "payslip-import-process" %}', {
      method: 'POST',
      body: formData,
      headers: {
        'X-CSRFToken': '{{ csrf_token }}'
      }
    })
      .then(response => response.json())
      .then(data => {
        if (data.status === 'success') {
          showAlert(data.message, 'success');
          // Optionally reload page after 2 seconds
          setTimeout(() => {
            window.location.reload();
          }, 2000);
        } else {
          showAlert(data.message, 'error');
          submitBtn.disabled = false;
          submitBtn.textContent = 'Submit';
        }
      })
      .catch(error => {
        console.error('Error:', error);
        showAlert('An error occurred while processing the file.', 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit';
      });
  }

  // Show alert message
  function showAlert(message, type) {
    const alertContainer = document.getElementById('alertContainer');
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type === 'success' ? 'success' : 'error'}`;
    alertDiv.textContent = message;
    alertContainer.innerHTML = '';
    alertContainer.appendChild(alertDiv);

    // Auto remove after 5 seconds
    setTimeout(() => {
      alertDiv.remove();
    }, 5000);
  }

  // --- External Components UI & Logic ---
  // Use the navbar-selected company (stored server-side). No extra company dropdown here.
  document.addEventListener("DOMContentLoaded", function () {
    const externalToggle = document.getElementById("external-components-toggle");
    const externalList = document.getElementById("external-components-list");

    if (!externalToggle || !externalList) return;

    externalToggle.addEventListener("click", function (e) {
      e.preventDefault();
      // Fetch and download using server-selected company
      fetch("{% url 'external-components-export' %}", {
        headers: { "X-Requested-With": "XMLHttpRequest" },
      })
        .then((res) => {
          if (!res.ok) throw new Error("Failed to fetch external components");
          return res.text();
        })
        .then((csv) => {
          // Populate list for quick preview (first 10)
          externalList.innerHTML = "";
          const lines = csv.split("\n").slice(1).filter((l) => l.trim());
          lines.slice(0, 10).forEach((line) => {
            const parts = line.split(",");
            const empId = (parts[0] || "").replace(/(^\"|\"$)/g, "");
            const empName = (parts[1] || "").replace(/(^\"|\"$)/g, "");
            const li = document.createElement("li");
            li.textContent = `${empId} ‚Äî ${empName}`;
            externalList.appendChild(li);
          });
          externalList.classList.remove("d-none");

          // Trigger download
          const blob = new Blob([csv], { type: "text/csv;charset=utf-8;" });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "external_components.csv";
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        })
        .catch((err) => {
          console.error(err);
          showAlert("{% trans 'Failed to fetch external components.' %}", "error");
        });
    });
  });
</script>

{% endblock content %}
