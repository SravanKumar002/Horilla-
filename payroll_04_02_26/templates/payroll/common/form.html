{% extends 'index.html' %}
{% block content %}
{% load static %}

<div id="contractFormTarget">
    <div class="oh-wrapper d-flex justify-content-center mt-4 mb-4">
        <form action="" hx-swap="none" class="oh-onboarding-card" method="post" enctype="multipart/form-data">
            {% csrf_token %}
            {{ form.as_p }}
        </form>
    </div>

    <script>
        (function setupContractForm() {
            // ‚úÖ Fetch employee contract/work info
            window.contractInitial = function (element) {
                var employee_id = $(element).val();

                if (!employee_id) {
                    console.warn("‚ö†Ô∏è No employee selected");
                    return;
                }

                console.log("üîÑ Fetching contract info for employee:", employee_id);

                $.ajax({
                    type: "GET",
                    url: "{% url 'contract-info-initial' %}",
                    data: { employee_id: employee_id },
                    success: function (data) {
                        console.log("‚úÖ Data received:", data);

                        // Helper function to set values safely
                        function setVal(id, value) {
                            const el = document.getElementById(id);
                            if (el) {
                                $(el).val(value ?? "");
                                el.dispatchEvent(new Event("change"));
                            } else {
                                console.warn("‚ö†Ô∏è Field not found:", id);
                            }
                        }

                        // --- Fill all fields ---
                        setVal("id_department", data.department);
                        setVal("id_job_position", data.job_position);
                        setVal("id_job_role", data.job_role);
                        setVal("id_shift", data.shift);
                        setVal("id_work_type", data.work_type);
                        setVal("id_wage", data.wage);
                        setVal("id_contract_start_date", data.contract_start_date);
                        setVal("id_contract_end_date", data.contract_end_date);
                        setVal("id_housing_allowance", data.housing_allowance);
                        setVal("id_transport_allowance", data.transport_allowance);
                        setVal("id_other_allowance", data.other_allowance);
                        setVal("id_total_salary", data.total_salary);

                        // üßÆ Auto-calc total if not provided
                        if (!data.total_salary || data.total_salary === 0) {
                            calculateTotalSalary();
                        }
                    },
                    error: function (xhr) {
                        console.error("‚ùå Error fetching contract info:", xhr.responseText);
                    }
                });
            };

            // ‚úÖ Auto-update total salary when wage/allowances change
            function calculateTotalSalary() {
                let wage = parseFloat($("#id_wage").val()) || 0;
                let housing = parseFloat($("#id_housing_allowance").val()) || 0;
                let transport = parseFloat($("#id_transport_allowance").val()) || 0;
                let other = parseFloat($("#id_other_allowance").val()) || 0;
                let total = wage + housing + transport + other;
                $("#id_total_salary").val(total.toFixed(2));
            }

            // ‚úÖ Setup toggles and event bindings
            function bindFormEvents() {
                $("[type=checkbox]").off("change").on("change", function (e) {
                    e.preventDefault();
                    toggleFunction();
                    rangeToggle();
                });

                $("#id_is_condition_based").off("change").on("change", function () {
                    rangeToggle();
                });

                $("#id_wage, #id_housing_allowance, #id_transport_allowance, #id_other_allowance")
                    .off("input")
                    .on("input", calculateTotalSalary);

                // üîÅ Bind employee dropdown event
                const employeeField = document.querySelector("#id_employee");
                if (employeeField) {
                    employeeField.onchange = function () {
                        contractInitial(this);
                    };
                    console.log("‚úÖ Employee field bound successfully");
                } else {
                    console.warn("‚ö†Ô∏è Employee field not found, waiting...");
                }
            }

            // ‚úÖ Helper toggle functions (copied from your existing logic)
            function rangeToggle() {
                if ($("[name='if_condition']").val() == "range") {
                    $("[name='if_amount']").parent().hide();
                    $("[name='start_range']").parent().show();
                    $("[name='end_range']").parent().show();
                } else {
                    $("[name='if_amount']").parent().show();
                    $("[name='start_range']").parent().hide();
                    $("[name='end_range']").parent().hide();
                }
            }

            function toggleFunction() {
                if ($("#id_calculate_daily_leave_amount").is(":checked")) {
                    $("#id_deduction_for_one_leave_amount,[for=id_deduction_for_one_leave_amount]").hide();
                } else {
                    $("#id_deduction_for_one_leave_amount,[for=id_deduction_for_one_leave_amount]").show();
                }

                if ($("#id_calculate_daily_leave_amount").is(":checked")) {
                    $("#id_deduction_for_one_leave_amount").parent().hide();
                } else {
                    $("#id_deduction_for_one_leave_amount").parent().show();
                }
            }

            // ‚úÖ Run on normal page load
            document.addEventListener("DOMContentLoaded", bindFormEvents);

            // ‚úÖ Re-run bindings after any HTMX content refresh
            document.body.addEventListener("htmx:afterSwap", function () {
                console.log("‚ôªÔ∏è HTMX swap detected, rebinding form events...");
                bindFormEvents();
            });
        })();
    </script>
</div>

{% endblock content %}